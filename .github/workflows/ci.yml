name: ci

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: blacksmith-4vcpu-ubuntu-2404
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true
      - name: Install tools
        run: make tools
      - name: Format check
        run: make fmt-check
      - name: Test
        run: go test ./...
      - name: Dead code (blocking, CLI binary entrypoint)
        run: make deadcode
      - name: Race tests (blocking)
        run: make race
      - name: Coverage gate (blocking)
        run: make coverage COVERAGE_MIN=70
      - name: Lint
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            LINT_BASE="origin/${{ github.base_ref }}"
          else
            LINT_BASE="${{ github.event.before }}"
            if [ -z "${LINT_BASE}" ] || [ "${LINT_BASE}" = "0000000000000000000000000000000000000000" ]; then
              LINT_BASE="$(git merge-base HEAD origin/main)"
            fi
          fi
          make lint LINT_NEW_FROM="${LINT_BASE}"

  worker:
    runs-on: blacksmith-4vcpu-ubuntu-2404
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Enable Corepack (pnpm)
        run: |
          corepack enable
          corepack prepare pnpm@10.27.0 --activate
      - name: Install dependencies
        run: pnpm -C internal/tracking/worker install --frozen-lockfile
      - name: Lint
        run: pnpm -C internal/tracking/worker lint
      - name: Build
        run: pnpm -C internal/tracking/worker build
      - name: Test
        run: pnpm -C internal/tracking/worker test
